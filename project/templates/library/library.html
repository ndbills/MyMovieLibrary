{% extends "usernav.html" %}
{% block content %}
    <div class="col-sm-12">
        <div class="col-md-4">
            <h3>{{ library.name ~ ' ' ~ library.unit }} Library </h3>
        </div>
        <div class="btn-group pull-right">
            <button type="button" class="btn btn-default add-movie" data-toggle="modal" data-target="#addMovie-form">Add Movie</button>
        </div>
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <td>Movie</td>
                    <td>Rating</td>
                    <td class="hidden-xs">Summary</td>
                    <td class="hidden-xs">Options</td>
                </tr>
            </thead>
            <tbody>
                {% if library.collection|length  <= 0 %}
                    <tr> 
                        <td>No Movies are in this collection </td>
                    </tr>
                {% else %}
                    {% for movie in library.hydrateList() %}
                        <tr class='clickable' data-id='{{ loop.index }}'>
                        <td>
                            <img src="{{ movie.poster|default('') }}" style="max-width: 200px;" alt="{{ movie.title }}">
                            <p>{{ movie.title }}</p>
                             <div class="btn-group hidden-md hidden-lg">
                              <button type="button" class="btn btn-default btn-small lend-movie" data-id='{{ loop.index }}'>Lend</button>
                              <button type="button" class="btn btn-default btn-small borrow-movie" data-id='{{ loop.index }}'>Edit</button>
                              <button type="button" class="btn btn-default btn-small remove-movie" data-id='{{ loop.index }}'>Remove</button>
                            </div>
                        </td>
                        <td>
                            <div class='rating-text'style="">{{ movie.popularity }}</div>
                            <div class="rating">
                                {% set rating = 10 - movie.popularity|int %}
                                {% for i in range(10) %}
                                    {% if rating == i %}
                                        <span class="vert rated">☆</span>
                                    {% else %}
                                        <span class="vert">☆</span>
                                    {% endif %}    
                                {% endfor %}
                            </div>
                        </td>
                        <td class="hidden-xs">
                            {{ movie.summary }}
                        </td>
                        <td class="hidden-xs">
                            <div class="btn-group-vertical">
                              <button type="button" class="btn btn-default btn-small lend-movie" data-id='{{ loop.index }}'>Lend</button>
                              <button type="button" class="btn btn-default btn-small borrow-movie" data-id='{{ loop.index }}'>Edit</button>
                              <button type="button" class="btn btn-default btn-small remove-movie" data-id='{{ loop.index }}'>Remove</button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}

                {% endif %}
            </tbody>
        </table>
    </div>
{% endblock %}

{% block javascript %}
    <script>
        $(function(){
            var libraryPath = '{{ url_for("libraryItem", name=library.name, index="999") }}';
            $('.clickable').on('click',function(){
                var movie_id = $(this).data('id');
                window.document.location = libraryPath.replace('999',movie_id);
            });

            var removePath = '{{ url_for("removelibraryItem", name=library.name) }}';
            $('.remove-movie').on('click',function(event){
                var movie_id = $(this).data('id');
                {% if library.name == 'Master' %}
                   var message = "Removing a movie from your Master list will remove it from all other lists. Are you sure you want remove this movie? ";
                {% else %}
                    var message = "Are you sure you want remove this movie? ";
                {% endif %}
                if(confirm(message)){
                    event.stopPropagation();
                    event.preventDefault();
                    $.ajax({
                        url: removePath,
                        data: {id:movie_id},
                        method: 'POST',
                        success: function(data,status,jqXHR){
                            if(data['response'] == 'success'){
                                if(data['type'] == 'redirect'){
                                    window.document.location = data['path'];
                                } else if (data['type'] == 'reload') {
                                    window.document.location.reload();
                                }
                            }
                        },
                        error: function(jqXHR, textStatus, errorThrown){
                            response = jqXHR.responseJSON;
                            if('message' in response){
                                alert(response['message']);
                            }
                        }
                    });

                }
            });
        });
    </script>
{% endblock %}

{% block modals %}
    {% include 'library/addmovie_modal.html' %}
{% endblock %}